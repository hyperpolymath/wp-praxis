%% -*- erlang -*-
%% Rebar3 configuration for WP Praxis Manifest Parser
%% LFE-based symbolic manifest parsing and transformation

{erl_opts, [
    debug_info,
    warnings_as_errors,
    {i, "include"}
]}.

{plugins, [
    {rebar3_lfe, "0.4.8"}
]}.

{provider_hooks, [
    {pre, [{compile, {lfe, compile}}]}
]}.

{deps, [
    {lfe, "2.1.2"},
    {yamerl, "0.10.0"},  % YAML parsing
    {toml, "0.7.0"},     % TOML parsing
    {jsx, "3.1.0"}       % JSON encoding/decoding
]}.

{profiles, [
    {test, [
        {deps, [
            {ltest, "0.13.5"},
            {proper, "1.4.0"}
        ]},
        {eunit_opts, [verbose]},
        {erl_opts, [{src_dirs, ["src", "test"]}]}
    ]},
    {dev, [
        {deps, [
            {lfe_repl, "0.4.0"}
        ]}
    ]},
    {prod, [
        {erl_opts, [
            no_debug_info,
            warnings_as_errors,
            {d, 'PRODUCTION', true}
        ]}
    ]}
]}.

{dialyzer, [
    {warnings, [
        error_handling,
        race_conditions,
        underspecs,
        unknown
    ]},
    {get_warnings, true},
    {plt_apps, top_level_deps},
    {plt_extra_apps, [lfe, yamerl, toml, jsx]},
    {plt_location, local},
    {base_plt_apps, [stdlib, kernel, erts]},
    {base_plt_location, global}
]}.

{xref_checks, [
    undefined_function_calls,
    undefined_functions,
    locals_not_used,
    deprecated_function_calls,
    deprecated_functions
]}.

{cover_enabled, true}.
{cover_opts, [verbose]}.

{alias, [
    {test, [lfe_test]},
    {repl, [lfe_repl]},
    {check, [dialyzer, xref]}
]}.

%% Erlang compiler options
{erlc_compiler, [
    {recursive, true}
]}.

%% LFE compiler options
{lfe_first_files, [
    "src/symbolic-macros.lfe"  % Compile macros first
]}.

%% Documentation
{edoc_opts, [
    {preprocess, true},
    {includes, ["include"]},
    {title, "WP Praxis Manifest Parser"},
    {overview, "doc/overview.edoc"}
]}.

%% Release configuration
{relx, [
    {release, {manifest_parser, "0.1.0"}, [
        manifest_parser,
        sasl,
        yamerl,
        toml,
        jsx
    ]},
    {dev_mode, true},
    {include_erts, false},
    {extended_start_script, true},
    {sys_config, "config/sys.config"},
    {vm_args, "config/vm.args"}
]}.

%% Shell configuration
{shell, [
    {apps, [manifest_parser]},
    {config, "config/sys.config"}
]}.
